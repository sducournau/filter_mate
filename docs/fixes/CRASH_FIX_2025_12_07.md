# Diagnostic et Correction du Crash QGIS au Lancement de FilterMate

**Date:** 7 dÃ©cembre 2025  
**Version:** FilterMate v2.1.0  
**Statut:** âœ… CORRIGÃ‰

---

## ğŸ”´ PROBLÃˆME

QGIS crashe lors du lancement du plugin FilterMate.

---

## ğŸ” ANALYSE

### Causes IdentifiÃ©es

#### 1. **CAUSE PRINCIPALE : Race Condition d'Initialisation** (CRITIQUE)

**Localisation:** `filter_mate_app.py` ligne 160

**ProblÃ¨me:**
```python
def __init__(self, plugin_dir):
    # ... initialisation ...
    self.run()  # âš ï¸ APPEL IMMÃ‰DIAT dans __init__
```

`self.run()` Ã©tait appelÃ© **immÃ©diatement Ã  la fin du `__init__`**, crÃ©ant la dockwidget et connectant les signaux Qt AVANT que QGIS soit complÃ¨tement stable. Cela causait des **violations d'accÃ¨s mÃ©moire** (access violations) et des crashes.

**Impact:** Crash systÃ©matique au lancement sur certaines configurations.

---

#### 2. **Conflit PyQt5 vs qgis.PyQt** (HAUTE PRIORITÃ‰)

**Localisation:** `filter_mate_dockwidget_base.py` ligne 11

**ProblÃ¨me:**
```python
from PyQt5 import QtCore, QtGui, QtWidgets  # âŒ Mauvais
```

Le fichier UI compilÃ© utilisait `PyQt5` directement au lieu de `qgis.PyQt`, causant des incompatibilitÃ©s potentielles avec l'environnement Qt de QGIS.

**Impact:** InstabilitÃ©, conflits de versions Qt, crashes intermittents.

---

#### 3. **Imports Wildcard Excessifs** (MOYENNE PRIORITÃ‰)

**Localisation:** Multiples fichiers

**ProblÃ¨me:**
```python
from qgis.PyQt.QtCore import *
from qgis.PyQt.QtGui import *
from qgis.core import *
```

Ces imports wildcard peuvent causer des conflits de noms et des rÃ©fÃ©rences circulaires.

**Impact:** Augmente le risque de bugs subtils et de crashes.

---

#### 4. **AccÃ¨s PrÃ©maturÃ© Ã  `iface`** (FAIBLE PRIORITÃ‰)

**Localisation:** `filter_mate.py` et `filter_mate_app.py`

**ProblÃ¨me:**
```python
from qgis.utils import iface  # AccÃ¨s lors de l'import
```

L'accÃ¨s Ã  `iface` au moment de l'import peut Ã©chouer si l'interface n'est pas encore disponible.

**Impact:** Potentiellement dÃ©stabilisant lors du chargement initial.

---

## âœ… CORRECTIONS APPLIQUÃ‰ES

### 1. **DÃ©placement de l'Appel `run()`** âœ…

**Fichier:** `filter_mate_app.py`

**Modification:**
```python
def __init__(self, plugin_dir):
    # ... initialisation ...
    # Note: Do NOT call self.run() here - it will be called from filter_mate.py
    # when the user actually activates the plugin to avoid QGIS initialization race conditions
```

**RÃ©sultat:** `run()` n'est plus appelÃ© dans `__init__`, mais uniquement depuis `filter_mate.py` quand l'utilisateur active le plugin.

---

### 2. **Protection et Gestion d'Erreurs** âœ…

**Fichier:** `filter_mate.py`

**Modification:**
```python
def run(self):
    """Run method that loads and starts the plugin"""
    if not self.pluginIsActive:
        self.pluginIsActive = True
        try:
            if not self.app:
                # Create app WITHOUT calling run() automatically
                self.app = FilterMateApp(self.plugin_dir)
                # NOW call run() after QGIS is stable
                self.app.run()
                self.app.dockwidget.closingPlugin.connect(self.onClosePlugin)
            else:
                self.app.run()
                self.app.dockwidget.closingPlugin.connect(self.onClosePlugin)
                self.app.dockwidget.show()
        except Exception as e:
            iface.messageBar().pushCritical(
                "FilterMate",
                f"Error loading plugin: {str(e)}. Check QGIS Python console for details."
            )
            import traceback
            print(f"FilterMate Error: {traceback.format_exc()}")
            self.pluginIsActive = False
```

**RÃ©sultat:** 
- Gestion d'erreurs robuste
- Messages clairs Ã  l'utilisateur
- Traceback dans la console Python pour le debug

---

### 3. **Correction des Imports PyQt5** âœ…

**Fichier:** `filter_mate_dockwidget_base.py`

**Modification:**
```python
# MODIFIED: Use qgis.PyQt instead of PyQt5 for QGIS compatibility
from qgis.PyQt import QtCore, QtGui, QtWidgets
```

**RÃ©sultat:** Utilise maintenant les modules Qt fournis par QGIS.

---

### 4. **Script de Post-Compilation** âœ…

**Nouveau Fichier:** `fix_compiled_ui.py`

**Fonction:** Script automatique qui corrige les imports PyQt5 aprÃ¨s chaque compilation UI.

**Usage:**
```bash
python3 fix_compiled_ui.py [file_path]
```

**IntÃ©gration:** AjoutÃ© Ã  `compile_ui.sh` pour application automatique.

---

## ğŸ§ª TESTS RECOMMANDÃ‰S

### Test 1: Lancement Initial
```
1. RedÃ©marrer QGIS complÃ¨tement
2. Activer le plugin FilterMate via le menu Plugins
3. VÃ©rifier: Plugin se charge sans crash
4. VÃ©rifier: Dockwidget s'affiche correctement
```

### Test 2: Rechargement
```
1. DÃ©sactiver le plugin
2. RÃ©activer le plugin
3. VÃ©rifier: Pas de crash, pas de message d'erreur
```

### Test 3: Avec Projet Existant
```
1. Ouvrir un projet QGIS avec des couches vectorielles
2. Activer FilterMate
3. VÃ©rifier: Les couches sont listÃ©es correctement
4. VÃ©rifier: Pas d'erreur dans la console Python
```

### Test 4: Projet Vide
```
1. CrÃ©er un nouveau projet vide
2. Activer FilterMate
3. VÃ©rifier: Plugin s'active sans crash
4. VÃ©rifier: Interface correctement dÃ©sactivÃ©e (aucune couche)
```

---

## ğŸ“‹ CHECKLIST DE VÃ‰RIFICATION

- [x] Code modifiÃ© dans `filter_mate_app.py`
- [x] Code modifiÃ© dans `filter_mate.py`
- [x] Imports PyQt5 corrigÃ©s dans `filter_mate_dockwidget_base.py`
- [x] Script `fix_compiled_ui.py` crÃ©Ã©
- [x] Script `compile_ui.sh` mis Ã  jour
- [ ] Tests manuels effectuÃ©s dans QGIS
- [ ] Validation sur Windows
- [ ] Validation sur Linux
- [ ] Tests avec projets rÃ©els
- [ ] Mise Ã  jour CHANGELOG.md

---

## ğŸ”„ WORKFLOW DE COMPILATION

**Nouveau workflow avec correction automatique:**

```bash
# 1. Modifier l'UI dans Qt Designer (filter_mate_dockwidget_base.ui)

# 2. Compiler l'UI
bash compile_ui.sh

# 3. Le script applique automatiquement:
#    - Compilation pyuic5
#    - Correction PyQt5 -> qgis.PyQt
#    - Backup automatique

# 4. Le fichier .py est prÃªt Ã  l'emploi
```

---

## ğŸ“ NOTES TECHNIQUES

### Ordre d'Initialisation Correct

```
1. filter_mate.py: classFactory(iface) appelÃ© par QGIS
2. FilterMate.__init__() crÃ©Ã©
3. FilterMate.initGui() appelÃ©
4. Utilisateur clique sur l'icÃ´ne du plugin
5. FilterMate.run() appelÃ©
6. FilterMateApp.__init__() appelÃ© (sans run())
7. FilterMateApp.run() appelÃ© explicitement
8. Dockwidget crÃ©Ã© et affichÃ©
9. Signaux Qt connectÃ©s
```

### Protection Contre les Crashes Futurs

1. **try/except robuste** dans `filter_mate.py:run()`
2. **Messages d'erreur clairs** avec contexte
3. **Traceback dans console** pour debugging
4. **Flag `pluginIsActive`** rÃ©initialisÃ© en cas d'erreur
5. **Imports Qt standardisÃ©s** via `qgis.PyQt`

---

## ğŸš€ PROCHAINES Ã‰TAPES

### ImmÃ©diat
1. âœ… Tester le lancement dans QGIS
2. âœ… VÃ©rifier les logs Python Console
3. âœ… Valider fonctionnalitÃ© de base

### Court Terme
1. â³ RÃ©viser tous les imports wildcard
2. â³ Ajouter plus de logging pour tracking
3. â³ Mettre Ã  jour la documentation

### Moyen Terme
1. ğŸ“‹ Audit complet de la gestion des signaux Qt
2. ğŸ“‹ Optimisation de l'ordre d'initialisation
3. ğŸ“‹ Tests automatisÃ©s pour prÃ©venir rÃ©gressions

---

## ğŸ“š RÃ‰FÃ‰RENCES

- [QGIS Plugin Development Best Practices](https://docs.qgis.org/latest/en/docs/pyqgis_developer_cookbook/)
- [Qt Signal/Slot Thread Safety](https://doc.qt.io/qt-5/threads-qobject.html)
- FilterMate Issue: Crash au lancement (7 dÃ©c 2025)

---

## ğŸ‘¤ CONTRIBUTEURS

- **Analyse et Correction:** GitHub Copilot (Claude Sonnet 4.5)
- **Validation:** [Ã€ complÃ©ter aprÃ¨s tests]

---

**FIN DU DIAGNOSTIC**
