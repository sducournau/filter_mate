"""\nUnit tests for GeometryCache.\n\nTests task-level geometry caching logic.\nPart of Phase E13 refactoring (January 2026).\n"""\n\nimport unittest\nfrom unittest.mock import Mock, MagicMock, patch\n\nfrom core.tasks.cache.geometry_cache import GeometryCache\n\n\nclass TestGeometryCache(unittest.TestCase):\n    """Test GeometryCache class."""\n    \n    def setUp(self):\n        """Set up test fixtures."""\n        self.cache = GeometryCache(max_size=10)\n    \n    def test_initialization(self):\n        """Test cache initialization."""\n        self.assertEqual(self.cache._max_size, 10)\n        self.assertEqual(len(self.cache), 0)\n    \n    def test_get_put_basic(self):\n        """Test basic get/put operations."""\n        layer_id = "layer_123"\n        geometry_data = {"wkt": "POINT(0 0)", "bbox": [0, 0, 1, 1]}\n        \n        # Put geometry\n        self.cache.put(\n            layer_id=layer_id,\n            geometry=geometry_data,\n            feature_ids=[1, 2, 3]\n        )\n        \n        # Get geometry\n        cached = self.cache.get(layer_id=layer_id, feature_ids=[1, 2, 3])\n        \n        self.assertIsNotNone(cached)\n        self.assertEqual(len(self.cache), 1)\n    \n    def test_get_miss(self):\n        """Test cache miss."""\n        cached = self.cache.get(layer_id="nonexistent")\n        \n        self.assertIsNone(cached)\n    \n    def test_max_size_eviction(self):\n        """Test FIFO eviction when max size reached."""\n        # Fill cache to max\n        for i in range(15):\n            self.cache.put(\n                layer_id=f"layer_{i}",\n                geometry={"wkt": f"POINT({i} {i})"},\n                feature_ids=[i]\n            )\n        \n        # Cache should not exceed max size\n        self.assertLessEqual(len(self.cache), 10)\n    \n    def test_invalidate_layer(self):\n        """Test invalidating specific layer."""\n        # Add multiple entries for same layer\n        layer_id = "layer_123"\n        \n        self.cache.put(layer_id=layer_id, geometry={"wkt": "POINT(0 0)"}, feature_ids=[1])\n        self.cache.put(layer_id=layer_id, geometry={"wkt": "POINT(1 1)"}, feature_ids=[2])\n        \n        # Invalidate layer\n        count = self.cache.invalidate_layer(layer_id)\n        \n        # Should have removed entries\n        self.assertGreaterEqual(count, 0)\n    \n    def test_clear(self):\n        """Test clearing entire cache."""\n        # Add some entries\n        for i in range(5):\n            self.cache.put(\n                layer_id=f"layer_{i}",\n                geometry={"wkt": f"POINT({i} {i})"}\n            )\n        \n        self.assertGreater(len(self.cache), 0)\n        \n        # Clear cache\n        self.cache.clear()\n        \n        self.assertEqual(len(self.cache), 0)\n    \n    def test_get_stats(self):\n        """Test getting cache statistics."""\n        stats = self.cache.get_stats()\n        \n        self.assertIsInstance(stats, dict)\n        self.assertIn('size', stats)\n        self.assertIn('max_size', stats)\n    \n    def test_shared_instance(self):\n        """Test shared singleton instance."""\n        instance1 = GeometryCache.get_shared_instance()\n        instance2 = GeometryCache.get_shared_instance()\n        \n        self.assertIs(instance1, instance2)\n    \n    def test_different_contexts(self):\n        """Test caching with different contexts (buffer, CRS, subset)."""\n        layer_id = "layer_123"\n        feature_ids = [1, 2, 3]\n        \n        # Put with buffer\n        self.cache.put(\n            layer_id=layer_id,\n            geometry={"wkt": "POLYGON(...)"},\n            feature_ids=feature_ids,\n            buffer_value=10.0\n        )\n        \n        # Get with same buffer - should hit\n        cached = self.cache.get(\n            layer_id=layer_id,\n            feature_ids=feature_ids,\n            buffer_value=10.0\n        )\n        self.assertIsNotNone(cached)\n        \n        # Get with different buffer - should miss\n        cached = self.cache.get(\n            layer_id=layer_id,\n            feature_ids=feature_ids,\n            buffer_value=20.0\n        )\n        self.assertIsNone(cached)\n\n\nif __name__ == '__main__':\n    unittest.main()